{% extends "base.html" %}

{% block title %}Chat{% endblock %}

{% block head %}
  {{ super() }}
{% endblock %}

{% block body %}
  <h1>Chat</h1>
  <div class="chat-container" id="chat-container">
    {% for msg in conversation %}
      {% if msg.role == 'assistant' %}
        <p><strong>{{ msg.role.capitalize() }}:</strong> {{ msg.content|safe }}</p>
      {% else %}
        <p><strong>{{ msg.role.capitalize() }}:</strong> {{ msg.content|e }}</p>
      {% endif %}
    {% endfor %}
  </div>

  <div class="loading-spinner" id="loading-spinner" style="display: none;"></div>
  <form id="chat-form">
    <p>
      <input type="text" name="message" id="message" placeholder="Type your message" required style="width: 80%;">
    </p>
    <p><input type="submit" value="Send"></p>
  </form>
  <p><a href="{{ url_for('upload') }}">Upload another file</a></p>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    // Update chat display with current conversation
    function updateChat(conversation) {
      $('#chat-container').empty();
      conversation.forEach(function(msg) {
        console.log("updateChat");
        if (msg.role === 'assistant') {
          $('#chat-container').append('<p><strong>' + msg.role.charAt(0).toUpperCase() + msg.role.slice(1) + ':</strong> ' + msg.content + '</p>');
        } else {
          $('#chat-container').append('<p><strong>' + msg.role.charAt(0).toUpperCase() + msg.role.slice(1) + ':</strong> ' + $('<div>').text(msg.content).html() + '</p>');
        }
      });
    }

    // Function to request the next file chunk from the server
    function sendNextChunk() {
      $.ajax({
        type: 'POST',
        url: '{{ url_for("send_chunk") }}',
        success: function(response) {
          console.log("sendNextChunk");
          updateChat(response.conversation);
          if (response.chunk_remaining > 0) {
            // Wait 1 second before sending the next chunk
            setTimeout(sendNextChunk, 1000);
          }
        },
        error: function() {
          console.error("Error sending file chunk.");
        }
      });
    }

    $(document).ready(function() {
      // On page load, automatically trigger sending of file chunks.
      $.ajax({
        type: 'POST',
        url: '{{ url_for("send_chunk") }}',
        success: function(response) {
          updateChat(response.conversation);
          if (response.chunk_remaining > 0) {
            setTimeout(sendNextChunk, 1000);
          }
        },
        error: function() {
          console.error("Error initializing file chunk sending.");
        }
      });

      // Handle user sending a message.
      $('#chat-form').on('submit', function(event) {
        event.preventDefault();
        var message = $('#message').val();
        $('#loading-spinner').show();
        $.ajax({
          type: 'POST',
          url: '{{ url_for("chat_post") }}',
          data: { message: message },
          success: function(response) {
            updateChat(response.conversation);
            $('#message').val('');
          },
          complete: function() {
            $('#loading-spinner').hide();
          }
        });
      });
    });
  </script>
{% endblock %}
